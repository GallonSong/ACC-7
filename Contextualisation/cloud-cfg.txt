#cloud-config

apt_update: true
apt_upgrade: true
packages:
 - build-essential
byobu_default: system 

write_files:
  - path: /etc/docker/daemon.json
    content: |
      {
      "mtu": 1400
      }

  - path: /home/ubuntu/airfoil/tasks.py
    content: |
      from celery import Celery
      app = Celery('tasks', broker='amqp://')
      @app.task
      def test():
          return "this is a test"

  - path: /home/ubuntu/airfoil/Dockerfile
    content: |
      FROM docker.io/gallonsong/acc-7:airfoil_service
      WORKDIR /home/fenics/shared/
      COPY tasks.py .
      CMD ["celery worker", "-A", "tasks", "-D", "-l", "INFO"]

runcmd:
 - source /home/ubuntu/.bashrc
 - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
 - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
 - sudo apt-get update
 - sudo apt-get install -y docker-ce
 - cd /home/ubuntu/airfoil/
 - sudo docker build -t airfoil_worker .
 - sudo docker run -d airfoil_worker
